<% subtotal = 0 %>
<!-- need '@order_items.first' because '@order_items is an
ActiveRecord::Associations' object -->
<!-- <% order = Order.find(@order_items.first.order_id) %> -->

<h4>Order Placed: <%= Time.now.strftime("%m/%d/%Y at %R") %></h4>
<h4>Order Status: <%= @order.status.capitalize %></h4>

<table class="table">
  <tr>
    <th>Name</th>
    <th>Price</th>
    <th>Qty</th>
    <th>Total</th>
  </tr>
  <% @order_items.each do |item| %>
  <tr>
    <% product = Product.find(item.product_id) %>
    <td> <%= link_to  product.name, product_path(product) %> </td>
    <td> <%= number_to_currency(product.price) %> </td>
    <td>
      <%= item.quantity %>
    </td>
    <td> <%= number_to_currency(product.price * item.quantity) %> </td>

		<% subtotal += (product.price * item.quantity) %>
  </tr>
  <% end %>

	<tr>
		<td colspan="2">
		</td>
		<td>
			Subtotal:
		</td>
		<td>
			<%= number_to_currency(subtotal) %>
		</td>
	</tr>
	<tr>
		<td colspan="2">
		</td>
		<td>
			Tax:
		</td>
		<td>
			<% tax = subtotal * 0.095 %>
			<%= number_to_currency(tax) %>
		</td>
	</tr>
	<tr>
		<td colspan="2">
		</td>
		<td>
			Total:
		</td>
		<td>
			<%= number_to_currency(subtotal + tax) %>
		</td>
	</tr>
</table>

<% if session[:user_id] %>
  <%= link_to "Back to Dashboard", user_path(session[:user_id]), class: "btn btn-default" %>
  <!-- status changes to "cancelled", session order_id == nil, redirect_to root_path -->
  <%= link_to "Cancel Order", order_path(@order), method: :delete, class: "btn btn-danger" %>
<% else %>
  <!-- status stays the same, session order_id == nil, redirect_to root_path -->
  <%= link_to "Go Home", logout_path, method: :delete, class: "btn btn-default" %>
  <!-- status changes to "cancelled", session order_id == nil, redirect_to root_path -->
  <%= link_to "Cancel Order", order_path(@order), method: :delete, class: "btn btn-danger" %>
<% end %>
